name: Win32 Comprehensive Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  win32-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language: [us, br]
        priority_group: [critical, high, medium, low]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml rich aiohttp
    
    - name: Create reports directory
      run: mkdir -p tests/reports
    
    - name: Run Win32 tests
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        GITHUB_ACTIONS: ${{ secrets.ACTIONS }}
      run: |
        echo "🚀 Running Win32 tests for ${{ matrix.language }}-${{ matrix.priority_group }}"
        python tests/automated_win32_tests.py \
          --language ${{ matrix.language }} \
          --priorities ${{ matrix.priority_group }} \
          --concurrent 3 \
          --timeout 20 \
          --quiet
    
    - name: Upload test reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: win32-test-reports-${{ matrix.language }}-${{ matrix.priority_group }}
        path: tests/reports/
        retention-days: 30

  aggregate-results:
    needs: win32-tests
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Generate comprehensive summary
      run: |
        echo "# 📊 Win32 API Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Language | Priority | Success Rate | Total | Passed | Failed | Errors |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|----------|--------------|-------|--------|--------|--------|" >> $GITHUB_STEP_SUMMARY
        
        for report in $(find . -name "win32_tests_report_*.json" -type f); do
          if [ -f "$report" ]; then
            echo "Processing report: $report"
            total=$(jq -r '.summary.total_tested // 0' "$report")
            passed=$(jq -r '.summary.passed // 0' "$report")
            failed=$(jq -r '.summary.failed // 0' "$report")
            errors=$(jq -r '.summary.parser_errors // 0' "$report")
            success_rate=$(jq -r '.summary.success_rate // 0' "$report")
            
            if echo "$report" | grep -q "us-"; then
              language="English"
              priority=$(echo "$report" | sed -n 's/.*us-\([^/]*\).*/\1/p')
            elif echo "$report" | grep -q "br-"; then
              language="Português"
              priority=$(echo "$report" | sed -n 's/.*br-\([^/]*\).*/\1/p')
            else
              language="Unknown"
              priority="Unknown"
            fi
            
            if [ $(echo "$success_rate >= 90" | bc -l) -eq 1 ]; then
              status_emoji="✅"
            elif [ $(echo "$success_rate >= 70" | bc -l) -eq 1 ]; then
              status_emoji="⚠️"
            else
              status_emoji="❌"
            fi
            
            printf "| %s | %s | %s %.1f%% | %s | %s | %s | %s |\n" \
              "$language" "$priority" "$status_emoji" "$success_rate" \
              "$total" "$passed" "$failed" "$errors"
          fi
        done >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## 🎯 Database Statistics" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Functions in Database**: 1052" >> $GITHUB_STEP_SUMMARY
        echo "- **Categories Covered**: Network, Security, Graphics, System, etc." >> $GITHUB_STEP_SUMMARY
        echo "- **Sources**: Microsoft Official Index + Community Lists" >> $GITHUB_STEP_SUMMARY
        
    - name: Check overall health
      run: |
        echo "✅ Win32 API testing pipeline completed successfully"
        echo "📈 All test matrices have been processed"
        echo "📊 Results are available in the summary above"