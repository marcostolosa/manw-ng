name: ğŸš€ Release Build

on:
  push:
    tags:
      - 'v*'
      - 'release-*'

env:
  PYTHON_VERSION: '3.11'

jobs:
  create-release:
    name: ğŸ·ï¸ Create Release
    runs-on: ubuntu-latest
    environment: manw-ng
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      tag_name: ${{ steps.get_tag.outputs.tag }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ·ï¸ Get tag name
      id: get_tag
      run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: ğŸ“ Generate release notes
      id: release_notes
      run: |
        # Gera notas de release automaticamente
        if git show-ref --verify --quiet refs/heads/main; then
          DEFAULT_BRANCH="main"
        else
          DEFAULT_BRANCH="master"
        fi
        
        echo "## ğŸ†• Changes in ${{ steps.get_tag.outputs.tag }}" > release_notes.md
        echo "" >> release_notes.md
        
        # Pega commits desde a Ãºltima tag
        LAST_TAG=$(git describe --tags --abbrev=0 ${{ steps.get_tag.outputs.tag }}^ 2>/dev/null || echo "")
        if [ -n "$LAST_TAG" ]; then
          echo "### ğŸ“‹ Commits since $LAST_TAG:" >> release_notes.md
          git log --pretty=format:"- %s (%h)" $LAST_TAG..${{ steps.get_tag.outputs.tag }} >> release_notes.md
        else
          echo "### ğŸ“‹ All commits in this release:" >> release_notes.md  
          git log --pretty=format:"- %s (%h)" >> release_notes.md
        fi
        
        echo "" >> release_notes.md
        echo "## ğŸ“¦ Available Downloads" >> release_notes.md
        echo "- **Windows x64**: win32-scraper-windows-x64.exe" >> release_notes.md
        echo "- **Windows x86**: win32-scraper-windows-x86.exe" >> release_notes.md
        echo "- **Linux x64**: win32-scraper-linux-x64" >> release_notes.md
        echo "- **Linux x86**: win32-scraper-linux-x86" >> release_notes.md
        echo "" >> release_notes.md
        echo "## ğŸš€ Usage" >> release_notes.md
        echo "\`\`\`bash" >> release_notes.md
        echo "./win32-scraper-linux-x64 CreateProcessW" >> release_notes.md
        echo "win32-scraper-windows-x64.exe HeapAlloc --output json" >> release_notes.md
        echo "\`\`\`" >> release_notes.md

    - name: ğŸ“¦ Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.ACTIONS }}
      with:
        tag_name: ${{ steps.get_tag.outputs.tag }}
        name: Win32 API Scraper ${{ steps.get_tag.outputs.tag }}
        body_path: release_notes.md
        draft: false
        prerelease: false

  build-windows:
    name: ğŸªŸ Build Windows Binaries
    runs-on: windows-latest
    environment: manw-ng
    needs: create-release
    strategy:
      matrix:
        arch: [x64, x86]
        include:
          - arch: x64
            python-arch: x64
            artifact-name: win32-scraper-windows-x64.exe
          - arch: x86
            python-arch: x86
            artifact-name: win32-scraper-windows-x86.exe
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }} (${{ matrix.python-arch }})
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        architecture: ${{ matrix.python-arch }}

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: ğŸ§ª Run tests
      run: |
        pip install -r requirements-dev.txt
        python -m pytest tests/ -v --tb=short

    - name: ğŸ”¨ Build Windows ${{ matrix.arch }} executable
      run: |
        cp win32_scraper.spec win32_scraper_${{ matrix.arch }}.spec
        sed -i "s/name='win32-scraper'/name='${{ matrix.artifact-name }}'/g" win32_scraper_${{ matrix.arch }}.spec
        pyinstaller --clean --distpath=dist --workpath=build/${{ matrix.arch }} win32_scraper_${{ matrix.arch }}.spec
      shell: bash

    - name: âœ… Test executable
      run: |
        cd dist
        ./${{ matrix.artifact-name }} --help
      shell: bash

    - name: ğŸ“Š Get file info
      run: |
        cd dist
        ls -la ${{ matrix.artifact-name }}
        file ${{ matrix.artifact-name }} || echo "file command not available"
      shell: bash

    - name: ğŸ“¤ Upload Windows ${{ matrix.arch }} Binary
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.ACTIONS }}
      with:
        tag_name: ${{ needs.create-release.outputs.tag_name }}
        files: ./dist/${{ matrix.artifact-name }}

  build-linux:
    name: ğŸ§ Build Linux Binaries
    runs-on: ubuntu-latest
    environment: manw-ng
    needs: create-release
    strategy:
      matrix:
        arch: [x64, x86]
        include:
          - arch: x64
            python-arch: x64
            artifact-name: win32-scraper-linux-x64
            docker-platform: linux/amd64
          - arch: x86
            python-arch: x86
            artifact-name: win32-scraper-linux-x86
            docker-platform: linux/386

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ§ Set up QEMU for cross-compilation
      if: matrix.arch == 'x86'
      uses: docker/setup-qemu-action@v3

    - name: ğŸ”¨ Build Linux ${{ matrix.arch }} executable
      run: |
        if [ "${{ matrix.arch }}" == "x86" ]; then
          # Para x86, usa Docker com imagem 32-bit
          docker run --rm --platform=${{ matrix.docker-platform }} \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            i386/python:${{ env.PYTHON_VERSION }}-slim \
            bash -c "
              apt-get update && apt-get install -y gcc g++ zlib1g-dev zlib1g libc6-dev build-essential && \
              pip install --no-cache-dir -r requirements.txt && \
              pip install --no-cache-dir pyinstaller staticx && \
              cp win32_scraper_static.spec win32_scraper_x86.spec && \
              sed -i \"s/name='win32-scraper'/name='${{ matrix.artifact-name }}'/g\" win32_scraper_x86.spec && \
              pyinstaller --clean --distpath=dist --workpath=build/x86 win32_scraper_x86.spec && \
              cd dist && staticx ${{ matrix.artifact-name }} ${{ matrix.artifact-name }}_static && mv ${{ matrix.artifact-name }}_static ${{ matrix.artifact-name }}
            "
        else
          # Para x64, usa runner nativo
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          cp win32_scraper.spec win32_scraper_x64.spec
          sed -i "s/name='win32-scraper'/name='${{ matrix.artifact-name }}'/g" win32_scraper_x64.spec
          pyinstaller --clean --distpath=dist --workpath=build/x64 win32_scraper_x64.spec
        fi

    - name: âœ… Test executable
      run: |
        cd dist
        ./${{ matrix.artifact-name }} --help

    - name: ğŸ“Š Get file info
      run: |
        cd dist
        ls -la ${{ matrix.artifact-name }}
        file ${{ matrix.artifact-name }}
        ldd ${{ matrix.artifact-name }} || echo "Statically linked or ldd not available"

    - name: ğŸ“¤ Upload Linux ${{ matrix.arch }} Binary  
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.ACTIONS }}
      with:
        tag_name: ${{ needs.create-release.outputs.tag_name }}
        files: ./dist/${{ matrix.artifact-name }}

  notify-completion:
    name: ğŸ“¢ Release Notification
    runs-on: ubuntu-latest
    needs: [create-release, build-windows, build-linux]
    if: always()

    steps:
    - name: ğŸ“¢ Success notification
      if: needs.build-windows.result == 'success' && needs.build-linux.result == 'success'
      run: |
        echo "ğŸ‰ Release ${{ needs.create-release.outputs.tag_name }} completed successfully!"
        echo "âœ… Windows x64 binary created"
        echo "âœ… Windows x86 binary created" 
        echo "âœ… Linux x64 binary created"
        echo "âœ… Linux x86 binary created"
        echo ""
        echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ needs.create-release.outputs.tag_name }}"

    - name: ğŸ“¢ Failure notification
      if: needs.build-windows.result == 'failure' || needs.build-linux.result == 'failure'
      run: |
        echo "âŒ Release build failed!"
        echo "Windows build: ${{ needs.build-windows.result }}"
        echo "Linux build: ${{ needs.build-linux.result }}"
        exit 1